# Домашнее задание к занятию «Микросервисы: подходы»

Вы работаете в крупной компании, которая строит систему на основе микросервисной архитектуры.
Вам как DevOps-специалисту необходимо выдвинуть предложение по организации инфраструктуры для разработки и эксплуатации.


## Задача 1: Обеспечить разработку

Предложите решение для обеспечения процесса разработки: хранение исходного кода, непрерывная интеграция и непрерывная поставка. 
Решение может состоять из одного или нескольких программных продуктов и должно описывать способы и принципы их взаимодействия.

Решение должно соответствовать следующим требованиям:
- облачная система;
- система контроля версий Git;
- репозиторий на каждый сервис;
- запуск сборки по событию из системы контроля версий;
- запуск сборки по кнопке с указанием параметров;
- возможность привязать настройки к каждой сборке;
- возможность создания шаблонов для различных конфигураций сборок;
- возможность безопасного хранения секретных данных (пароли, ключи доступа);
- несколько конфигураций для сборки из одного репозитория;
- кастомные шаги при сборке;
- собственные докер-образы для сборки проектов;
- возможность развернуть агентов сборки на собственных серверах;
- возможность параллельного запуска нескольких сборок;
- возможность параллельного запуска тестов.

Обоснуйте свой выбор.

|           | Базовое решение                                                                                                         | Продвинутое решение                                                                                         |
|------------------------|-----------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------|
| Система            | GitLab                                                                                                                      | GitLab                                                                                                          |
| Тип                | Community Edition (CE) подходит, но Enterprise предпочтительнее для больших команд разработки и сложных продуктов.         | Используется как система контроля версий, управление проектами, репозитории и CI/CD.                            |
| Cloud-native       | GitLab изначально cloud-native. Доступен GitLab Managed Service в Yandex Cloud или можно развернуть в своем k8s кластере.  |                                                                                                                 |
| Управление хранилищем | Основывается на Git с использованием Gitaly для управления хранилищем.                                                  |                                                                                                                 |
| Ограничения по репозиториям | Нет ограничений по количеству репозиториев.                                                                          |                                                                                                                 |
| CI/CD функциональность | Полноценный GitLab CI/CD с гибкой настройкой запуска пайплайнов по событиям в git (commit, MR), по расписанию, вручную. | Можно использовать Jenkins для вынесения CI/CD из GitLab в случае недостатка возможностей для кастомизации.     |
| Параметры пайплайнов | Параметры можно задавать на уровне проекта, группы или системы.                                                         |                                                                                                                 |
| Хранение секретов  | Возможность хранения секретов на уровне проекта или группы, интеграция с внешним хранилищем секретов Vault через JWT.       | Hashicorp Vault используется для хранения секретов.                                                             |
| Конфигурации сборки | Несколько конфигураций для сборки из одного репозитория возможно реализовать через логику в пайплайне.                   |                                                                                                                 |
| GitLab Runners     | Используют docker engine для выполнения джобов, написанных на скриптовых языках.                                          |                                                                                                                 |
| Параллельное выполнение джобов | Раннеры не ограничены в количестве и поддерживают режим concurrency.                                            |                                                                                                                 |
| Хранилища артефактов | Имеются свои хранилища Package Registry и Container Registry для хранения собранных образов Docker.                     | Sonatype Nexus используется для хранения артефактов.                                                            |

## Задача 2: Логи

Предложите решение для обеспечения сбора и анализа логов сервисов в микросервисной архитектуре.
Решение может состоять из одного или нескольких программных продуктов и должно описывать способы и принципы их взаимодействия.

Решение должно соответствовать следующим требованиям:
- сбор логов в центральное хранилище со всех хостов, обслуживающих систему;
- минимальные требования к приложениям, сбор логов из stdout;
- гарантированная доставка логов до центрального хранилища;
- обеспечение поиска и фильтрации по записям логов;
- обеспечение пользовательского интерфейса с возможностью предоставления доступа разработчикам для поиска по записям логов;
- возможность дать ссылку на сохранённый поиск по записям логов.

Обоснуйте свой выбор.

|               | Стек ELK                                                                 | Grafana Stack                                                                                             |
|---------------------------|-----------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------|
| Компоненты            | Elasticsearch, Logstash, Kibana                                             | Promtail, Grafana Loki, S3-совместимое хранилище, Grafana                                                    |
| Сбор логов            | Logstash для сбора и обработки логов                                        | Promtail (устанавливается в k8s через Helm или как DaemonSet)                                               |
| Обработка и индексация| Elasticsearch для хранения и индексации данных                             | Grafana Loki для обработки и индексации логов                                                                  |
| Хранение данных       | Elasticsearch                                                              | Объектное хранилище (S3 managed в Yandex Cloud, MinIO, Ceph и т.д.)                                         |
| Визуализация и анализ | Kibana                                                                      | Grafana                                                                                                       |
| Система               | Не облачный, требует ресурсов для работы                                    | Cloud-native, состоит из микросервисов, легко масштабируется                                                  |
| Тип системы           | Pull-система (может потерять данные при сбое)                              | Push-система (данные сохраняются в Promtail до тех пор, пока Grafana Loki не станет доступен)                 |
| Ресурсозатратность    | Более ресурсоемкий (использует Java)                                      | Менее ресурсозатратный (индексирует только метаданные, написан на Go)                                       |
| Хранение в облаке     | Требует отдельного решения для хранения данных в облаке                    | Поддерживает хранение данных во внешнем S3-хранилище                                                          |
| Обнаружение таргетов  | Требует настройки                                                          | Promtail может автоматически обнаруживать таргеты по принципу Prometheus                                      |
| Возможности визуализации| Ограниченные возможности анализа и алертинга                            | Широкие возможности визуализации, анализа и алертинга                                                         |
| Агент для сбора данных| Нет единого агента для всех типов данных                                   | Grafana Agent позволяет собирать логи, метрики и трейсы, отправляя их в Grafana Loki, Mimir и Tempo           |


## Задача 3: Мониторинг

Предложите решение для обеспечения сбора и анализа состояния хостов и сервисов в микросервисной архитектуре.
Решение может состоять из одного или нескольких программных продуктов и должно описывать способы и принципы их взаимодействия.

Решение должно соответствовать следующим требованиям:
- сбор метрик со всех хостов, обслуживающих систему;
- сбор метрик состояния ресурсов хостов: CPU, RAM, HDD, Network;
- сбор метрик потребляемых ресурсов для каждого сервиса: CPU, RAM, HDD, Network;
- сбор метрик, специфичных для каждого сервиса;
- пользовательский интерфейс с возможностью делать запросы и агрегировать информацию;
- пользовательский интерфейс с возможностью настраивать различные панели для отслеживания состояния системы.

Обоснуйте свой выбор.

| Решение                                  | Описание                                                                                                                | Плюсы                                                                                                                                                             |
|----------------------------------------------|----------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 1. Стек VictoriaMetrics + Grafana       | VictoriaMetrics как замена Prometheus, оптимизированный для cloud-native среды.                                            | - Эффективное и масштабируемое хранение больших объемов данных.<br>- vmagent работает стабильнее Prometheus благодаря разделению функционала.<br>- Полноценная замена Prometheus. |
| 2. Стек Grafana Agent + Grafana Mimir + S3 + Grafana | Grafana Agent для сбора метрик, Grafana Mimir как долгосрочное хранилище, S3 для хранения данных.                         | - Mimir имеет структуру, схожую с Loki, легко масштабируется.<br>- Один агент Grafana Agent для сбора всех данных и выполнения target discovery.<br>- Упрощенная конфигурация для пользователей, знакомых с Prometheus.<br>- Поддержка различных источников данных, включая Mimir как Prometheus-like источник. |
