# Домашнее задание к занятию «Сетевое взаимодействие в Kubernetes»

### Примерное время выполнения задания

120 минут

### Цель задания

Научиться настраивать доступ к приложениям в Kubernetes:
- Внутри кластера через **Service** (ClusterIP, NodePort).
- Снаружи кластера через **Ingress**.

Это задание поможет вам освоить базовые принципы сетевого взаимодействия в Kubernetes — ключевого навыка для работы с кластерами.
На практике Service и Ingress используются для доступа к приложениям, балансировки нагрузки и маршрутизации трафика. Понимание этих механизмов поможет вам упростить управление сервисами в рабочих окружениях и снизит риски ошибок при развёртывании.

------

## **Подготовка**
### **Чеклист готовности**
- Установлен Kubernetes (MicroK8S, Minikube или другой).
- Установлен `kubectl`.
- Редактор для YAML-файлов (VS Code, Vim и др.).

<img width="1111" height="442" alt="image" src="https://github.com/user-attachments/assets/c3047078-44da-4a53-8f7c-f88ca71a2792" />

## **Задание 1: Настройка Service (ClusterIP и NodePort)**
### **Задача**
Развернуть приложение из двух контейнеров (`nginx` и `multitool`) и обеспечить доступ к ним:
- Внутри кластера через **ClusterIP**.
- Снаружи через **NodePort**.

### **Шаги выполнения**
1. **Создать Deployment** с двумя контейнерами:
   - `nginx` (порт `80`).
   - `multitool` (порт `8080`).
   - Количество реплик: `3`.
2. **Создать Service типа ClusterIP**, который:
   - Открывает `nginx` на порту `9001`.
   - Открывает `multitool` на порту `9002`.
3. **Проверить доступность** изнутри кластера:
```bash
 kubectl run test-pod --image=wbitt/network-multitool --rm -it -- sh
 curl <service-name>:9001 # Проверить nginx
 curl <service-name>:9002 # Проверить multitool
```
4. **Создать Service типа NodePort** для доступа к `nginx` снаружи.
5. **Проверить доступ** с локального компьютера:
```bash
 curl <node-ip>:<node-port>
   ```
 или через браузер.

### **Что сдать на проверку**

Все манифесты находятся по пути https://github.com/Kulikova-A18/NETOLOGY-SHVIRTD-17/tree/main/kuber-homeworks/1.4%20/2

- Манифесты:
  - `deployment-multi-container.yaml`

```
apiVersion: apps/v1
kind: Deployment
metadata:
  name: web
  labels:
    app: web
spec:
  replicas: 3
  selector:
    matchLabels:
      app: web
  template:
    metadata:
      labels:
        app: web
    spec:
      containers:
      - name: nginx
        image: nginx:1.19.2
        ports:
        - containerPort: 80
      - name: multitool
        image: wbitt/network-multitool
        env:
          - name: HTTP_PORT
            value: "8080"
        ports:
        - containerPort: 8080
          name: http
```

  - `service-clusterip.yaml`

```
apiVersion: v1
kind: Service
metadata:
  name: multi-container-clusterip
spec:
  ports:
    - name: http-nginx
      port: 9001
      protocol: TCP
      targetPort: 80
    - name: http-multitool
      port: 9002
      protocol: TCP
      targetPort: 8080
  selector:
    app: web
```
  
  - `service-nodeport.yaml`

```
apiVersion: v1
kind: Service
metadata:
  name: multi-container-nodeport
spec:
  ports:
    - name: http-nginx
      port: 9001
      protocol: TCP
      targetPort: 80
    - name: http-multitool
      port: 9002
      protocol: TCP
      targetPort: 8080
  selector:
    app: web
```

запуск
```
vboxuser@xubu:~/1.4$ microk8s kubectl apply -f . 
deployment.apps/web unchanged
pod/multitool created
service/multi-container-clusterip unchanged
service/multi-container-nodeport unchanged
vboxuser@xubu:~/1.4$ microk8s kubectl get po
NAME                  READY   STATUS    RESTARTS   AGE
multitool             1/1     Running   0          3s
web-c66b5cc5c-2bvfp   2/2     Running   0          98s
web-c66b5cc5c-94br6   2/2     Running   0          98s
web-c66b5cc5c-kgwwn   2/2     Running   0          98s
vboxuser@xubu:~/1.4$ kubectl get svc -o wide
NAME                        TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)             AGE   SELECTOR
kubernetes                  ClusterIP   10.152.183.1     <none>        443/TCP             33m   <none>
multi-container-clusterip   ClusterIP   10.152.183.184   <none>        9001/TCP,9002/TCP   10m   app=web
multi-container-nodeport    ClusterIP   10.152.183.207   <none>        9001/TCP,9002/TCP   10m   app=web
vboxuser@xubu:~/1.4$ kubectl get pods -o wide
NAME                  READY   STATUS    RESTARTS   AGE     IP           NODE   NOMINATED NODE   READINESS GATES
multitool             1/1     Running   0          2m9s    10.1.17.15   xubu   <none>           <none>
web-c66b5cc5c-2bvfp   2/2     Running   0          3m44s   10.1.17.12   xubu   <none>           <none>
web-c66b5cc5c-94br6   2/2     Running   0          3m44s   10.1.17.14   xubu   <none>           <none>
web-c66b5cc5c-kgwwn   2/2     Running   0          3m44s   10.1.17.13   xubu   <none>           <none>

```

- Скриншоты проверки доступа (`curl` или браузер).

<img width="867" height="864" alt="image" src="https://github.com/user-attachments/assets/590c9695-5e40-4ca7-b042-1af9aa0ddc0e" />

<img width="983" height="116" alt="image" src="https://github.com/user-attachments/assets/8e545694-d397-4fcd-8cb1-c4c2890f023a" />

---
## **Задание 2: Настройка Ingress**
### **Задача**
Развернуть два приложения (`frontend` и `backend`) и обеспечить доступ к ним через **Ingress** по разным путям.

### **Шаги выполнения**
1. **Развернуть два Deployment**:
   - `frontend` (образ `nginx`).
   - `backend` (образ `wbitt/network-multitool`).
2. **Создать Service** для каждого приложения.
3. **Включить Ingress-контроллер**:
```bash
 microk8s enable ingress
   ```
4. **Создать Ingress**, который:
   - Открывает `frontend` по пути `/`.
   - Открывает `backend` по пути `/api`.
5. **Проверить доступность**:
```bash
 curl <host>/
 curl <host>/api
   ```
 или через браузер.

### **Что сдать на проверку**
- Манифесты:
  - `deployment-frontend.yaml`
  - `deployment-backend.yaml`
  - `service-frontend.yaml`
  - `service-backend.yaml`
  - `ingress.yaml`

<img width="1023" height="367" alt="image" src="https://github.com/user-attachments/assets/83a5b9c6-7c50-4b02-8195-b65afca05a65" />

```
vboxuser@xubu:~/1.4$ microk8s kubectl apply -f . 
deployment.apps/backend created
deployment.apps/frontend created
ingress.networking.k8s.io/my-ingress created
service/backend created
service/frontend created
vboxuser@xubu:~/1.4$ 
vboxuser@xubu:~/1.4$ 
vboxuser@xubu:~/1.4$ 
vboxuser@xubu:~/1.4$ kubectl get po
NAME                        READY   STATUS    RESTARTS   AGE
backend-b57968f8d-6kj2d     1/1     Running   0          3s
frontend-54758c4c55-m74bb   1/1     Running   0          3s
multitool                   1/1     Running   0          22m
vboxuser@xubu:~/1.4$
vboxuser@xubu:~/1.4$    microk8s enable ingress
   
Infer repository core for addon ingress
Enabling Ingress
ingressclass.networking.k8s.io/public created
ingressclass.networking.k8s.io/nginx created
namespace/ingress created
serviceaccount/nginx-ingress-microk8s-serviceaccount created
clusterrole.rbac.authorization.k8s.io/nginx-ingress-microk8s-clusterrole created
role.rbac.authorization.k8s.io/nginx-ingress-microk8s-role created
clusterrolebinding.rbac.authorization.k8s.io/nginx-ingress-microk8s created
rolebinding.rbac.authorization.k8s.io/nginx-ingress-microk8s created
configmap/nginx-load-balancer-microk8s-conf created
configmap/nginx-ingress-tcp-microk8s-conf created
configmap/nginx-ingress-udp-microk8s-conf created
daemonset.apps/nginx-ingress-microk8s-controller created
Ingress is enabled
vboxuser@xubu:~/1.4$ kubectl get svc -o wide
NAME                        TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)             AGE   SELECTOR
backend                     ClusterIP   10.152.183.152   <none>        80/TCP              84s   app=backend
frontend                    ClusterIP   10.152.183.125   <none>        80/TCP              84s   app=frontend
kubernetes                  ClusterIP   10.152.183.1     <none>        443/TCP             56m   <none>
multi-container-clusterip   ClusterIP   10.152.183.184   <none>        9001/TCP,9002/TCP   33m   app=web
multi-container-nodeport    ClusterIP   10.152.183.207   <none>        9001/TCP,9002/TCP   33m   app=web
vboxuser@xubu:~/1.4$ kubectl get pods -o wide
NAME                        READY   STATUS    RESTARTS   AGE    IP           NODE   NOMINATED NODE   READINESS GATES
backend-b57968f8d-6kj2d     1/1     Running   0          102s   10.1.17.17   xubu   <none>           <none>
frontend-54758c4c55-m74bb   1/1     Running   0          102s   10.1.17.18   xubu   <none>           <none>
multitool                   1/1     Running   0          24m    10.1.17.15   xubu   <none>           <none>

```

- Скриншоты проверки доступа (`curl` или браузер).

<img width="679" height="366" alt="image" src="https://github.com/user-attachments/assets/a112398c-9356-4038-856d-eb2176f66f81" />

<img width="990" height="498" alt="image" src="https://github.com/user-attachments/assets/f0a071eb-d512-419f-b2ec-e181cb2a72a2" />
