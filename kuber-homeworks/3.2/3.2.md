# Домашнее задание к занятию «Установка Kubernetes»

### Цель задания

Установить кластер K8s.

### Чеклист готовности к домашнему заданию

1. Развёрнутые ВМ с ОС Ubuntu 20.04-lts.


### Инструменты и дополнительные материалы, которые пригодятся для выполнения задания

1. [Инструкция по установке kubeadm](https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/).
2. [Документация kubespray](https://kubespray.io/).

-----

### Задание 1. Установить кластер k8s с 1 master node

1. Подготовка работы кластера из 5 нод: 1 мастер и 4 рабочие ноды.
2. В качестве CRI — containerd.
3. Запуск etcd производить на мастере.
4. Способ установки выбрать самостоятельно.

подготовка с помощью следующих команд

```
$ git clone https://github.com/kubernetes-sigs/kubespray
$ sudo apt install pip
$ python3 -m pip --version
$ sudo apt install python3-venv
$ python3 -m venv myenv
$ source myenv/bin/activate
$ pip install -r requirements.txt
```

результат pip install

```
$ pip install -r requirements.txt
Collecting ansible==10.7.0 (from -r requirements.txt (line 1))
  Downloading ansible-10.7.0-py3-none-any.whl.metadata (8.0 kB)
Collecting cryptography==45.0.5 (from -r requirements.txt (line 3))
  Downloading cryptography-45.0.5-cp311-abi3-manylinux_2_34_x86_64.whl.metadata (5.7 kB)
Collecting jmespath==1.0.1 (from -r requirements.txt (line 5))
  Downloading jmespath-1.0.1-py3-none-any.whl.metadata (7.6 kB)
Collecting netaddr==1.3.0 (from -r requirements.txt (line 7))
  Downloading netaddr-1.3.0-py3-none-any.whl.metadata (5.0 kB)
Collecting ansible-core~=2.17.7 (from ansible==10.7.0->-r requirements.txt (line 1))
  Downloading ansible_core-2.17.13-py3-none-any.whl.metadata (7.0 kB)
Collecting cffi>=1.14 (from cryptography==45.0.5->-r requirements.txt (line 3))
  Downloading cffi-1.17.1-cp313-cp313-manylinux_2_17_x86_64.manylinux2014_x86_64.whl.metadata (1.5 kB)
Collecting jinja2>=3.0.0 (from ansible-core~=2.17.7->ansible==10.7.0->-r requirements.txt (line 1))
  Downloading jinja2-3.1.6-py3-none-any.whl.metadata (2.9 kB)
Collecting PyYAML>=5.1 (from ansible-core~=2.17.7->ansible==10.7.0->-r requirements.txt (line 1))
  Downloading PyYAML-6.0.2-cp313-cp313-manylinux_2_17_x86_64.manylinux2014_x86_64.whl.metadata (2.1 kB)
Collecting packaging (from ansible-core~=2.17.7->ansible==10.7.0->-r requirements.txt (line 1))
  Downloading packaging-25.0-py3-none-any.whl.metadata (3.3 kB)
Collecting resolvelib<1.1.0,>=0.5.3 (from ansible-core~=2.17.7->ansible==10.7.0->-r requirements.txt (line 1))
  Downloading resolvelib-1.0.1-py2.py3-none-any.whl.metadata (4.0 kB)
Collecting pycparser (from cffi>=1.14->cryptography==45.0.5->-r requirements.txt (line 3))
  Downloading pycparser-2.22-py3-none-any.whl.metadata (943 bytes)
Collecting MarkupSafe>=2.0 (from jinja2>=3.0.0->ansible-core~=2.17.7->ansible==10.7.0->-r requirements.txt (line 1))
  Downloading MarkupSafe-3.0.2-cp313-cp313-manylinux_2_17_x86_64.manylinux2014_x86_64.whl.metadata (4.0 kB)
Downloading ansible-10.7.0-py3-none-any.whl (51.6 MB)
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 51.6/51.6 MB 3.0 MB/s eta 0:00:00
Downloading cryptography-45.0.5-cp311-abi3-manylinux_2_34_x86_64.whl (4.5 MB)
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 4.5/4.5 MB 3.2 MB/s eta 0:00:00
Downloading jmespath-1.0.1-py3-none-any.whl (20 kB)
Downloading netaddr-1.3.0-py3-none-any.whl (2.3 MB)
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 2.3/2.3 MB 3.0 MB/s eta 0:00:00
Downloading ansible_core-2.17.13-py3-none-any.whl (2.2 MB)
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 2.2/2.2 MB 2.5 MB/s eta 0:00:00
Downloading cffi-1.17.1-cp313-cp313-manylinux_2_17_x86_64.manylinux2014_x86_64.whl (479 kB)
Downloading jinja2-3.1.6-py3-none-any.whl (134 kB)
Downloading PyYAML-6.0.2-cp313-cp313-manylinux_2_17_x86_64.manylinux2014_x86_64.whl (759 kB)
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 759.5/759.5 kB 3.4 MB/s eta 0:00:00
Downloading resolvelib-1.0.1-py2.py3-none-any.whl (17 kB)
Downloading packaging-25.0-py3-none-any.whl (66 kB)
Downloading pycparser-2.22-py3-none-any.whl (117 kB)
Downloading MarkupSafe-3.0.2-cp313-cp313-manylinux_2_17_x86_64.manylinux2014_x86_64.whl (23 kB)
Installing collected packages: resolvelib, PyYAML, pycparser, packaging, netaddr, MarkupSafe, jmespath, jinja2, cffi, cryptography, ansible-core, ansible
Successfully installed MarkupSafe-3.0.2 PyYAML-6.0.2 ansible-10.7.0 ansible-core-2.17.13 cffi-1.17.1 cryptography-45.0.5 jinja2-3.1.6 jmespath-1.0.1 netaddr-1.3.0 packaging-25.0 pycparser-2.22 resolvelib-1.0.1
(myenv) 
```

подготовка inventory/mycluster/hosts.yaml

<img width="743" height="200" alt="image" src="https://github.com/user-attachments/assets/753148d6-ed31-4ea0-9d82-64520229c3a3" />

```
$ cat 'inventory/mycluster/hosts.yaml' 
all:
  hosts:
    master:
      ansible_host: 10.129.0.13
      ip: 10.129.0.13
      access_ip: 10.129.0.13
      ansible_user: user
    worker1:
      ansible_host: 10.129.0.6
      ip: 10.129.0.6
      access_ip: 10.129.0.6
      ansible_user: user
    worker2:
      ansible_host: 10.129.0.11
      ip: 10.129.0.11
      access_ip: 10.129.0.11
      ansible_user: user
    worker3:
      ansible_host: 10.129.0.33
      ip: 10.129.0.33
      access_ip: 10.129.0.33
      ansible_user: user
    worker4:
      ansible_host: 10.129.0.7
      ip: 10.129.0.7
      access_ip: 10.129.0.7
      ansible_user: user
  children:
    kube_control_plane:
      hosts:
        master:
    kube_node:
      hosts:
        worker1:
        worker2:
        worker3:
        worker4: 
    etcd:
      hosts:
        master:
    k8s_cluster:
      children:
        kube_control_plane:
        kube_node:
    calico_rr:
      hosts: {}
```

запуск playbook ansible-playbook -i inventory/mycluster/hosts.yaml cluster.yml -b -v

```
PLAY RECAP **************************************************************************************************************************************************************************
localhost                  : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
master                     : ok=739  changed=146  unreachable=0    failed=0    skipped=1266 rescued=0    ignored=8
worker1                    : ok=512  changed=91   unreachable=0    failed=0    skipped=777  rescued=0    ignored=1
worker2                    : ok=512  changed=91   unreachable=0    failed=0    skipped=776  rescued=0    ignored=1
worker3                    : ok=512  changed=91   unreachable=0    failed=0    skipped=776  rescued=0    ignored=1
worker4                    : ok=512  changed=91   unreachable=0    failed=0    skipped=776  rescued=0    ignored=1

Thursday 07 August 2025  08:55:41 +0000 (0:00:00.330)      
===============================================================================
download : Download_file | Download item ------------------------------------------------------------------------------------------------------------------------------------ 21.16s
container-engine/nerdctl : Download_file | Download item -------------------------------------------------------------------------------------------------------------------- 51.18s
container-engine/containerd : Download_file | Download item ----------------------------------------------------------------------------------------------------------------- 47.25s
container-engine/crictl : Download_file | Download item --------------------------------------------------------------------------------------------------------------------- 45.11s
container-engine/runc : Download_file | Download item ----------------------------------------------------------------------------------------------------------------------- 45.01s
network_plugin/calico : Wait for calico kubeconfig to be created ------------------------------------------------------------------------------------------------------------ 43.73s
download : Download_container | Download image if required ------------------------------------------------------------------------------------------------------------------ 38.87s
download : Download_file | Download item ------------------------------------------------------------------------------------------------------------------------------------ 35.50s
container-engine/crictl : Extract_file | Unpacking archive ------------------------------------------------------------------------------------------------------------------ 31.60s
container-engine/nerdctl : Extract_file | Unpacking archive ----------------------------------------------------------------------------------------------------------------- 31.42s
download : Download_container | Download image if required ------------------------------------------------------------------------------------------------------------------ 27.84s
download : Download_container | Download image if required ------------------------------------------------------------------------------------------------------------------ 27.41s
download : Download_file | Download item ------------------------------------------------------------------------------------------------------------------------------------ 27.20s
kubernetes/control-plane : Kubeadm | Initialize first master ---------------------------------------------------------------------------------------------------------------- 26.82s
container-engine/containerd : Download_file | Validate mirrors -------------------------------------------------------------------------------------------------------------- 24.32s
container-engine/runc : Download_file | Validate mirrors -------------------------------------------------------------------------------------------------------------------- 21.64s
container-engine/crictl : Download_file | Validate mirrors ------------------------------------------------------------------------------------------------------------------ 25.45s
container-engine/nerdctl : Download_file | Validate mirrors ----------------------------------------------------------------------------------------------------------------- 23.37s
kubernetes/kubeadm : Join to cluster ---------------------------------------------------------------------------------------------------------------------------------------- 22.59s
kubernetes/preinstall : Update package management cache (APT) --------------------------------------------------------------------------------------------------------------- 21.78s
```

```
$kubectl get nodes
NAME        STATUS   ROLES           AGE   VERSION
master      Ready    control-plane   41m   v1.26.7
worker1     Ready    <none>          41m   v1.26.7
worker2     Ready    <none>          41m   v1.26.7
worker3     Ready    <none>          41m   v1.26.7
worker4     Ready    <none>          41m   v1.26.7
```
