# Домашнее задание к занятию «Запуск приложений в K8S»

### Цель задания

В тестовой среде для работы с Kubernetes, установленной в предыдущем ДЗ, необходимо развернуть Deployment с приложением, состоящим из нескольких контейнеров, и масштабировать его.

------

### Чеклист готовности к домашнему заданию

1. Установленное k8s-решение (например, MicroK8S).
2. Установленный локальный kubectl.
3. Редактор YAML-файлов с подключённым git-репозиторием.

------

### Инструменты и дополнительные материалы, которые пригодятся для выполнения задания

1. [Описание](https://kubernetes.io/docs/concepts/workloads/controllers/deployment/) Deployment и примеры манифестов.
2. [Описание](https://kubernetes.io/docs/concepts/workloads/pods/init-containers/) Init-контейнеров.
3. [Описание](https://github.com/wbitt/Network-MultiTool) Multitool.

------

### Задание 1. Создать Deployment и обеспечить доступ к репликам приложения из другого Pod

1. Создать Deployment приложения, состоящего из двух контейнеров — nginx и multitool. Решить возникшую ошибку.

Конфиг Deployment kuber-homeworks/1.3/files/deployment.yaml

```
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-multitool
  labels:
    app: nginx-multi
spec:
  replicas: 2
  selector:
    matchLabels:
      app: nginx-multi
  template:
    metadata:
      labels:
        app: nginx-multi
    spec:
      containers:
      - name: nginx
        image: nginx:latest
        ports:
        - containerPort: 80
 
      - name: multitool
        image: wbitt/network-multitool
        ports:
        - containerPort: 8080
        env: 
          - name: HTTP_PORT
            value: "9080"
```

| Поле                     | Описание                                                                                                 |
|--------------------------|----------------------------------------------------------------------------------------------------------|
| apiVersion             | Версия API, используемая для определения типа объекта. В данном случае используется apps/v1.         |
| kind                   | Тип объекта, который описывается. В данном случае это Deployment.                                    |
| metadata               | Метаданные объекта, включая имя и метки.                                                                |
| name                   | Имя деплоймента, в данном случае nginx-multitool.                                                    |
| labels                 | Метки, которые могут использоваться для выбора объектов. Здесь метка app: nginx-multi.               |
| spec                   | Спецификация объекта, описывающая желаемое состояние.                                                   |
| replicas               | Количество реплик (экземпляров) контейнеров, которые должны быть запущены. Здесь указано 2.           |
| selector               | Условия выбора подов, которые будут управляться данным деплойментом.                                   |
| matchLabels            | Метки, которые должны совпадать с подами для управления ими.                                          |
| template               | Шаблон для создания подов.                                                                                |
| metadata (внутри template) | Метаданные для подов, включая их метки.                                                               |
| labels (внутри template)  | Метки для подов, здесь также указана app: nginx-multi.                                              |
| spec (внутри template)    | Спецификация пода, описывающая контейнеры и их настройки.                                             |
| containers             | Список контейнеров, которые будут запущены в поде.                                                     |
| name (внутри containers)  | Имя первого контейнера, здесь это nginx.                                                             |
| image (внутри containers) | Docker-образ, который будет использоваться для контейнера. Здесь используется nginx:latest.         |
| ports (внутри containers)  | Порты, на которых контейнер будет слушать входящие соединения. Здесь указан порт 80 для контейнера nginx. |
| name (второй контейнер)    | Имя второго контейнера, здесь это multitool.                                                         |
| image (второй контейнер)   | Docker-образ для второго контейнера. Здесь используется wbitt/network-multitool.                    |
| ports (второй контейнер)    | Порты для второго контейнера. Здесь указан порт 8080.                                                  |
| env                     | Переменные окружения для контейнера.                                                                     |
| name (переменная окружения) | Имя переменной окружения, здесь это HTTP_PORT.                                                      |
| value (переменная окружения)| Значение переменной окружения, здесь указано "9080".                                                  |

Созданный под

```
$ microk8s kubectl apply -f .
deployment.apps/nginx-multitool created
service/myservice created
pod/multitool created
pod/nginx created
service/nginx-multitool-svc created
$ microk8s kubectl get po
NAME                               READY   STATUS    RESTARTS        AGE
multitool                          1/1     Running   2 (2m14s ago)   17m
nginx                              1/1     Running   2 (2m14s ago)   17m
nginx-multitool-677bd88c6d-5r677   2/2     Running   4 (2m13s ago)   17m
nginx-multitool-677bd88c6d-dqgq8   2/2     Running   4 (2m13s ago)   17m
$ microk8s kubectl get pods --all-namespaces
NAMESPACE     NAME                                         READY   STATUS    RESTARTS         AGE
default       multitool                                    1/1     Running   2 (2m23s ago)    17m
default       nginx                                        1/1     Running   2 (2m23s ago)    17m
default       nginx-multitool-677bd88c6d-5r677             2/2     Running   4 (2m22s ago)    17m
default       nginx-multitool-677bd88c6d-dqgq8             2/2     Running   4 (2m22s ago)    17m
kube-system   calico-kube-controllers-5947598c79-jq9mc     1/1     Running   19 (2m22s ago)   5d6h
kube-system   calico-node-6scvh                            1/1     Running   11 (2m22s ago)   5d6h
kube-system   coredns-79b94494c7-4qkwr                     1/1     Running   11 (2m22s ago)   5d6h
kube-system   dashboard-metrics-scraper-5bd45c9dd6-g264w   1/1     Running   1 (2m22s ago)    4m6s
kube-system   kubernetes-dashboard-57bc5f89fb-w62b8        1/1     Running   1 (2m22s ago)    4m6s
kube-system   metrics-server-7dbd8b5cc9-z8rjh              1/1     Running   1 (2m23s ago)    4m8s

```

2. После запуска увеличить количество реплик работающего приложения до 2.

Созданный под

```
nginx-multitool-677bd88c6d-5r677   2/2     Running   4 (2m13s ago)   17m
nginx-multitool-677bd88c6d-dqgq8   2/2     Running   4 (2m13s ago)   17m
```


3. Продемонстрировать количество подов до и после масштабирования.

Оба контейнера работают

```
$ microk8s kubectl get pods --all-namespaces
NAMESPACE     NAME                                         READY   STATUS    RESTARTS         AGE
default       multitool                                    1/1     Running   2 (2m23s ago)    17m
default       nginx                                        1/1     Running   2 (2m23s ago)    17m
default       nginx-multitool-677bd88c6d-5r677             2/2     Running   4 (2m22s ago)    17m
default       nginx-multitool-677bd88c6d-dqgq8             2/2     Running   4 (2m22s ago)    17m
kube-system   calico-kube-controllers-5947598c79-jq9mc     1/1     Running   19 (2m22s ago)   5d6h
kube-system   calico-node-6scvh                            1/1     Running   11 (2m22s ago)   5d6h
kube-system   coredns-79b94494c7-4qkwr                     1/1     Running   11 (2m22s ago)   5d6h
kube-system   dashboard-metrics-scraper-5bd45c9dd6-g264w   1/1     Running   1 (2m22s ago)    4m6s
kube-system   kubernetes-dashboard-57bc5f89fb-w62b8        1/1     Running   1 (2m22s ago)    4m6s
kube-system   metrics-server-7dbd8b5cc9-z8rjh              1/1     Running   1 (2m23s ago)    4m8s
```

4. Создать Service, который обеспечит доступ до реплик приложений из п.1.

kuber-homeworks/1.3/files/svc-nginx-multitool.yaml

```
apiVersion: v1
kind: Service
metadata:
  name: nginx-multitool-svc
spec:
  selector:
    app: nginx-multi
  ports:
    - name: nginx
      protocol: TCP
      port: 80
      targetPort: 80
    - name: multitool
      protocol: TCP
      port: 8080
      targetPort: 9080
```


5. Создать отдельный Pod с приложением multitool и убедиться с помощью `curl`, что из пода есть доступ до приложений из п.1.

kuber-homeworks/1.3/files/pod-multitool.yaml

```
apiVersion: v1
kind: Pod
metadata:
  name: multitool
spec:
  containers:
  - name: multitool
    image: wbitt/network-multitool
```

Ответ с 80 порта от nginx

```
$ kubectl exec -it multitool -- bash
multitool:/# curl nginx-multitool-svc:80
<!DOCTYPE html>
<html>
<head>
<title>Welcome to nginx!</title>
<style>
html { color-scheme: light dark; }
body { width: 35em; margin: 0 auto;
font-family: Tahoma, Verdana, Arial, sans-serif; }
</style>
</head>
<body>
<h1>Welcome to nginx!</h1>
<p>If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.</p>
<p>For online documentation and support please refer
to
<a href=" http://nginx.org/ "> nginx.org </a>.<br/>
Commercial support is available at
<a href=" http://nginx.com/ "> nginx.com </a>.</p>
<p><em>Thank you for using nginx.</em></p>
</body>
</html>
multitool:/# curl nginx-multitool-svc:8080
WBITT Network MultiTool (with NGINX) - nginx-multitool-5fb98b8f4c-vrkf6 - 10.1.3.136 - HTTP: 9080 , HTTPS: 443 . (Formerly praqma/network-
multitool)
multitool:/#
```

Ответ с 8080 порта от wbitt/network-multitool. при повторых запросах ответ приходит с разных реплик контейнера. пример работы балансировщика нагрузки.

```
multitool:/# curl nginx-multitool-svc:8080
WBITT Network MultiTool (with NGINX) - nginx-multitool-5fb98b8f4c-vrkf6 - 10.1.3.136 - HTTP: 9080 , HTTPS: 443 . (Formerly praqma/network-
multitool)
multitool:/# curl nginx-multitool-svc:8080
WBITT Network MultiTool
multitool)
(with NGINX) - nginx-multitool-5fb98b8f4c-vrkf6 - 10.1.3.136 - HTTP: 9080 , HTTPS: 443 . (Formerly praqma/network-
multitool:/# curl nginx-multitool-svc:8080
WBITT Network
multitool)
MultiTool (with NGINX) - nginx-multitool-5fb98b8f4c-vrkf6 - 10.1.3.136 - HTTP: 9080 , HTTPS: 443 . (Formerly
praqma/network-
multitool:/# curl nginx-multitool-svc:8080
WBITT Network MultiTool
multitool)
(with NGINX) - nginx-multitool-5fb98b8f4c-d28s9 - 10.1.3.139 - HTTP: 9080 , HTTPS: 443 . (Formerly praqma/network-
multitool:/# curl nginx-multitool-svc:8080
WBITT Network MultiTool (with NGINX) - nginx-multitool-5fb98b8f4c-vrkf6 - 10.1.3.136 - HTTP: 9080 , HTTPS: 443 - (Formerly praqma/network-
multitool)
multitool:/# curl nginx-multitool-svc:8080
WBITT Network MultiTool (with NGINX) - nginx-multitool-5fb98b8f4c-d28s9 - 10.1.3.139 - HTTP: 9080 , HTTPS: 443 . (Formerly praqma/network-
multitool)
multitool:/# curl nginx-multitool-svc:8080
```

------

### Задание 2. Создать Deployment и обеспечить старт основного контейнера при выполнении условий

1. Создать Deployment приложения nginx и обеспечить старт контейнера только после того, как будет запущен сервис этого приложения.
2. Убедиться, что nginx не стартует. В качестве Init-контейнера взять busybox.
3. Создать и запустить Service. Убедиться, что Init запустился.
4. Продемонстрировать состояние пода до и после запуска сервиса.



```
$ microk8s kubectl apply -f files/pod-nginx.yaml 
pod/nginx unchanged
$ microk8s kubectl get po
NAME                               READY   STATUS     RESTARTS   AGE
multitool                          1/1     Running    3          29m
nginx                              0/1     Init:0/1   3          29m
nginx-multitool-677bd88c6d-5r677   2/2     Running    6          29m
nginx-multitool-677bd88c6d-dqgq8   2/2     Running    6          29m

```

не успех

```
nginx                              0/1     Init:0/1   3          29m
```

запустим и сервис kuber-homeworks/1.3/files/myservice.yaml

```
apiVersion: v1
kind: Service
metadata:
  name: myservice
spec:
  selector:
    app: web
  ports:
    - name: myservice
      protocol: TCP
      port: 80
      targetPort: 8080
```

а теперь так

```
$ microk8s kubectl get po
NAME                               READY   STATUS    RESTARTS   AGE
multitool                          1/1     Running   3          31m
nginx                              1/1     Running   3          31m
nginx-multitool-677bd88c6d-5r677   2/2     Running   6          31m
nginx-multitool-677bd88c6d-dqgq8   2/2     Running   6          31m
```

успех

<img width="1176" height="166" alt="image" src="https://github.com/user-attachments/assets/a10c2171-c042-4adf-b7fa-164d88a86b1e" />
