# Домашнее задание к занятию «Запуск приложений в K8S»

### Цель задания

В тестовой среде для работы с Kubernetes, установленной в предыдущем ДЗ, необходимо развернуть Deployment с приложением, состоящим из нескольких контейнеров, и масштабировать его.

------

### Чеклист готовности к домашнему заданию

1. Установленное k8s-решение (например, MicroK8S).
2. Установленный локальный kubectl.
3. Редактор YAML-файлов с подключённым git-репозиторием.

------

### Инструменты и дополнительные материалы, которые пригодятся для выполнения задания

1. [Описание](https://kubernetes.io/docs/concepts/workloads/controllers/deployment/) Deployment и примеры манифестов.
2. [Описание](https://kubernetes.io/docs/concepts/workloads/pods/init-containers/) Init-контейнеров.
3. [Описание](https://github.com/wbitt/Network-MultiTool) Multitool.

------

### Задание 1. Создать Deployment и обеспечить доступ к репликам приложения из другого Pod

1. Создать Deployment приложения, состоящего из двух контейнеров — nginx и multitool. Решить возникшую ошибку.

Конфиг Deployment kuber-homeworks/1.3/files/deployment.yaml

```
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-multitool
  labels:
    app: nginx-multi
spec:
  replicas: 2
  selector:
    matchLabels:
      app: nginx-multi
  template:
    metadata:
      labels:
        app: nginx-multi
    spec:
      containers:
      - name: nginx
        image: nginx:latest
        ports:
        - containerPort: 80
 
      - name: multitool
        image: wbitt/network-multitool
        ports:
        - containerPort: 8080
        env: 
          - name: HTTP_PORT
            value: "9080"
```

| Поле                     | Описание                                                                                                 |
|--------------------------|----------------------------------------------------------------------------------------------------------|
| apiVersion             | Версия API, используемая для определения типа объекта. В данном случае используется apps/v1.         |
| kind                   | Тип объекта, который описывается. В данном случае это Deployment.                                    |
| metadata               | Метаданные объекта, включая имя и метки.                                                                |
| name                   | Имя деплоймента, в данном случае nginx-multitool.                                                    |
| labels                 | Метки, которые могут использоваться для выбора объектов. Здесь метка app: nginx-multi.               |
| spec                   | Спецификация объекта, описывающая желаемое состояние.                                                   |
| replicas               | Количество реплик (экземпляров) контейнеров, которые должны быть запущены. Здесь указано 2.           |
| selector               | Условия выбора подов, которые будут управляться данным деплойментом.                                   |
| matchLabels            | Метки, которые должны совпадать с подами для управления ими.                                          |
| template               | Шаблон для создания подов.                                                                                |
| metadata (внутри template) | Метаданные для подов, включая их метки.                                                               |
| labels (внутри template)  | Метки для подов, здесь также указана app: nginx-multi.                                              |
| spec (внутри template)    | Спецификация пода, описывающая контейнеры и их настройки.                                             |
| containers             | Список контейнеров, которые будут запущены в поде.                                                     |
| name (внутри containers)  | Имя первого контейнера, здесь это nginx.                                                             |
| image (внутри containers) | Docker-образ, который будет использоваться для контейнера. Здесь используется nginx:latest.         |
| ports (внутри containers)  | Порты, на которых контейнер будет слушать входящие соединения. Здесь указан порт 80 для контейнера nginx. |
| name (второй контейнер)    | Имя второго контейнера, здесь это multitool.                                                         |
| image (второй контейнер)   | Docker-образ для второго контейнера. Здесь используется wbitt/network-multitool.                    |
| ports (второй контейнер)    | Порты для второго контейнера. Здесь указан порт 8080.                                                  |
| env                     | Переменные окружения для контейнера.                                                                     |
| name (переменная окружения) | Имя переменной окружения, здесь это HTTP_PORT.                                                      |
| value (переменная окружения)| Значение переменной окружения, здесь указано "9080".                                                  |

Созданный под

```

```

2. После запуска увеличить количество реплик работающего приложения до 2.

Созданный под

```

```


3. Продемонстрировать количество подов до и после масштабирования.

Оба контейнера работают

```

```

4. Создать Service, который обеспечит доступ до реплик приложений из п.1.

kuber-homeworks/1.3/files/svc-nginx-multitool.yaml

```
apiVersion: v1
kind: Service
metadata:
  name: nginx-multitool-svc
spec:
  selector:
    app: nginx-multi
  ports:
    - name: nginx
      protocol: TCP
      port: 80
      targetPort: 80
    - name: multitool
      protocol: TCP
      port: 8080
      targetPort: 9080
```


5. Создать отдельный Pod с приложением multitool и убедиться с помощью `curl`, что из пода есть доступ до приложений из п.1.

kuber-homeworks/1.3/files/pod-multitool.yaml

```
apiVersion: v1
kind: Pod
metadata:
  name: multitool
spec:
  containers:
  - name: multitool
    image: wbitt/network-multitool
```

Ответ с 80 порта от nginx

Ответ с 8080 порта от wbitt/network-multitool. при повторых запросах ответ приходит с разных реплик контейнера. пример работы балансировщика нагрузки.


Результат после увеличения количества реплик до 2-х

```

```


------

### Задание 2. Создать Deployment и обеспечить старт основного контейнера при выполнении условий

1. Создать Deployment приложения nginx и обеспечить старт контейнера только после того, как будет запущен сервис этого приложения.
2. Убедиться, что nginx не стартует. В качестве Init-контейнера взять busybox.
3. Создать и запустить Service. Убедиться, что Init запустился.
4. Продемонстрировать состояние пода до и после запуска сервиса.

сервис kuber-homeworks/1.3/files/myservice.yaml

```
apiVersion: v1
kind: Service
metadata:
  name: myservice
spec:
  selector:
    app: web
  ports:
    - name: myservice
      protocol: TCP
      port: 80
      targetPort: 8080
```

В Event видно, что nginx стартовал успешно

