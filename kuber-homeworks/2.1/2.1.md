# Домашнее задание к занятию «Хранение в K8s»

### Примерное время выполнения задания — 180 минут

### Цель задания

Научиться работать с хранилищами в тестовой среде Kubernetes:
- обеспечить обмен файлами между контейнерами пода;
- создавать **PersistentVolume** (PV) и использовать его в подах через **PersistentVolumeClaim** (PVC);
- объявлять свой **StorageClass** (SC) и монтировать его в под через **PVC**.

Это задание поможет вам освоить базовые принципы взаимодействия с хранилищами в Kubernetes — одного из ключевых навыков для работы с кластерами. На практике Volume, PV, PVC используются для хранения данных независимо от пода, обмена данными между подами и контейнерами внутри пода. Понимание этих механизмов поможет вам упростить проектирование слоя данных для приложений, разворачиваемых в кластере k8s.

------

## **Подготовка**
### **Чеклист готовности**

1. Установленное K8s-решение (допустим, MicroK8S).
2. Установленный локальный kubectl.
3. Редактор YAML-файлов с подключенным GitHub-репозиторием.

------

### Инструменты, которые пригодятся для выполнения задания

1. [Инструкция](https://microk8s.io/docs/getting-started) по установке MicroK8S.
2. [Инструкция](https://minikube.sigs.k8s.io/docs/start/?arch=%2Fwindows%2Fx86-64%2Fstable%2F.exe+download) по установке Minikube. 
3. [Инструкция](https://kubernetes.io/docs/tasks/tools/install-kubectl-windows/) по установке kubectl.
4. [Инструкция](https://marketplace.visualstudio.com/items?itemName=ms-kubernetes-tools.vscode-kubernetes-tools) по установке VS Code

### Дополнительные материалы, которые пригодятся для выполнения задания
1. [Описание Volumes](https://kubernetes.io/docs/concepts/storage/volumes/).
2. [Описание Ephemeral Volumes](https://kubernetes.io/docs/concepts/storage/volumes/).
3. [Описание PersistentVolume](https://kubernetes.io/docs/concepts/storage/persistent-volumes/).
4. [Описание PersistentVolumeClaim](https://kubernetes.io/docs/concepts/storage/persistent-volumes/#persistentvolumeclaims).
5. [Описание StorageClass](https://kubernetes.io/docs/concepts/storage/storage-classes/).
6. [Описание Multitool](https://github.com/wbitt/Network-MultiTool).

------

## Задание 1. Volume: обмен данными между контейнерами в поде
### Задача

Создать Deployment приложения, состоящего из двух контейнеров, обменивающихся данными.

### Шаги выполнения
1. Создать Deployment приложения, состоящего из контейнеров busybox и multitool.
2. Настроить busybox на запись данных каждые 5 секунд в некий файл в общей директории.
3. Обеспечить возможность чтения файла контейнером multitool.


### Что сдать на проверку
- Манифесты:
  - `containers-data-exchange.yaml`
- Скриншоты:
  - описание пода с контейнерами (`kubectl describe pods data-exchange`)
  - вывод команды чтения файла (`tail -f <имя общего файла>`)

### решение

```
vboxuser@xubu:~/2.1$ microk8s kubectl apply -f . 
deployment.apps/data-exchange created
vboxuser@xubu:~/2.1$ microk8s kubectl get po
NAME                             READY   STATUS    RESTARTS   AGE
data-exchange-598df4bc47-vkz27   2/2     Running   0          30s
multitool                        1/1     Running   4          76m
vboxuser@xubu:~/2.1$ microk8s kubectl describe pods data-exchange
Name:             data-exchange-598df4bc47-vkz27
Namespace:        default
Priority:         0
Service Account:  default
Node:             xubu/192.168.5.47
Start Time:       Sat, 02 Aug 2025 13:32:32 +0300
Labels:           app=data-exchange
                  pod-template-hash=598df4bc47
Annotations:      cni.projectcalico.org/containerID: 5de2a1b23969039fd962f3241223dfb13a9ca11c6ad1461dd3f82c74890cef86
                  cni.projectcalico.org/podIP: 10.1.17.38/32
                  cni.projectcalico.org/podIPs: 10.1.17.38/32
Status:           Running
IP:               10.1.17.38
IPs:
  IP:           10.1.17.38
Controlled By:  ReplicaSet/data-exchange-598df4bc47
Containers:
  writer:
    Container ID:  containerd://8fc95f6cb617fc8d3345bfdc581b1b94ef0b88f67dd8d0b345e6a05b59b26239
    Image:         busybox
    Image ID:      docker.io/library/busybox@sha256:f9a104fddb33220ec80fc45a4e606c74aadf1ef7a3832eb0b05be9e90cd61f5f
    Port:          <none>
    Host Port:     <none>
    Command:
      /bin/sh
      -c
    Args:
      while true; do echo $(date) >> /data/exchange.txt; sleep 5; done
    State:          Running
      Started:      Sat, 02 Aug 2025 13:32:36 +0300
    Ready:          True
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /data from shared-data (rw)
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-sg6xf (ro)
  reader:
    Container ID:  containerd://5078ea4eec4d604e1f69de7ed2451b4b7896e75eb424bd77742bb02d972f00ad
    Image:         busybox
    Image ID:      docker.io/library/busybox@sha256:f9a104fddb33220ec80fc45a4e606c74aadf1ef7a3832eb0b05be9e90cd61f5f
    Port:          <none>
    Host Port:     <none>
    Command:
      /bin/sh
      -c
    Args:
      tail -f /data/exchange.txt
    State:          Running
      Started:      Sat, 02 Aug 2025 13:32:37 +0300
    Ready:          True
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /data from shared-data (rw)
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-sg6xf (ro)
Conditions:
  Type                        Status
  PodReadyToStartContainers   True 
  Initialized                 True 
  Ready                       True 
  ContainersReady             True 
  PodScheduled                True 
Volumes:
  shared-data:
    Type:       EmptyDir (a temporary directory that shares a pod's lifetime)
    Medium:     
    SizeLimit:  <unset>
  kube-api-access-sg6xf:
    Type:                    Projected (a volume that contains injected data from multiple sources)
    TokenExpirationSeconds:  3607
    ConfigMapName:           kube-root-ca.crt
    ConfigMapOptional:       <nil>
    DownwardAPI:             true
QoS Class:                   BestEffort
Node-Selectors:              <none>
Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type    Reason     Age   From               Message
  ----    ------     ----  ----               -------
  Normal  Scheduled  98s   default-scheduler  Successfully assigned default/data-exchange-598df4bc47-vkz27 to xubu
  Normal  Pulling    98s   kubelet            Pulling image "busybox"
  Normal  Pulled     94s   kubelet            Successfully pulled image "busybox" in 3.653s (3.653s including waiting). Image size: 2156518 bytes.
  Normal  Created    94s   kubelet            Created container: writer
  Normal  Started    94s   kubelet            Started container writer
  Normal  Pulling    94s   kubelet            Pulling image "busybox"
  Normal  Pulled     93s   kubelet            Successfully pulled image "busybox" in 1.075s (1.075s including waiting). Image size: 2156518 bytes.
  Normal  Created    93s   kubelet            Created container: reader
  Normal  Started    93s   kubelet            Started container reader

vboxuser@xubu:~/2.1$ 
```

1. Вывод команды kubectl describe pods data-exchange.

```
vboxuser@xubu:~/2.1$ microk8s kubectl describe pods data-exchange
Name:             data-exchange-598df4bc47-vkz27
Namespace:        default
Priority:         0
Service Account:  default
Node:             xubu/192.168.5.47
Start Time:       Sat, 02 Aug 2025 13:32:32 +0300
Labels:           app=data-exchange
                  pod-template-hash=598df4bc47
Annotations:      cni.projectcalico.org/containerID: 5de2a1b23969039fd962f3241223dfb13a9ca11c6ad1461dd3f82c74890cef86
                  cni.projectcalico.org/podIP: 10.1.17.38/32
                  cni.projectcalico.org/podIPs: 10.1.17.38/32
Status:           Running
IP:               10.1.17.38
IPs:
  IP:           10.1.17.38
Controlled By:  ReplicaSet/data-exchange-598df4bc47
Containers:
  writer:
    Container ID:  containerd://8fc95f6cb617fc8d3345bfdc581b1b94ef0b88f67dd8d0b345e6a05b59b26239
    Image:         busybox
    Image ID:      docker.io/library/busybox@sha256:f9a104fddb33220ec80fc45a4e606c74aadf1ef7a3832eb0b05be9e90cd61f5f
    Port:          <none>
    Host Port:     <none>
    Command:
      /bin/sh
      -c
    Args:
      while true; do echo $(date) >> /data/exchange.txt; sleep 5; done
    State:          Running
      Started:      Sat, 02 Aug 2025 13:32:36 +0300
    Ready:          True
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /data from shared-data (rw)
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-sg6xf (ro)
  reader:
    Container ID:  containerd://5078ea4eec4d604e1f69de7ed2451b4b7896e75eb424bd77742bb02d972f00ad
    Image:         busybox
    Image ID:      docker.io/library/busybox@sha256:f9a104fddb33220ec80fc45a4e606c74aadf1ef7a3832eb0b05be9e90cd61f5f
    Port:          <none>
    Host Port:     <none>
    Command:
      /bin/sh
      -c
    Args:
      tail -f /data/exchange.txt
    State:          Running
      Started:      Sat, 02 Aug 2025 13:32:37 +0300
    Ready:          True
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /data from shared-data (rw)
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-sg6xf (ro)
Conditions:
  Type                        Status
  PodReadyToStartContainers   True 
  Initialized                 True 
  Ready                       True 
  ContainersReady             True 
  PodScheduled                True 
Volumes:
  shared-data:
    Type:       EmptyDir (a temporary directory that shares a pod's lifetime)
    Medium:     
    SizeLimit:  <unset>
  kube-api-access-sg6xf:
    Type:                    Projected (a volume that contains injected data from multiple sources)
    TokenExpirationSeconds:  3607
    ConfigMapName:           kube-root-ca.crt
    ConfigMapOptional:       <nil>
    DownwardAPI:             true
QoS Class:                   BestEffort
Node-Selectors:              <none>
Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type    Reason     Age    From               Message
  ----    ------     ----   ----               -------
  Normal  Scheduled  2m12s  default-scheduler  Successfully assigned default/data-exchange-598df4bc47-vkz27 to xubu
  Normal  Pulling    2m13s  kubelet            Pulling image "busybox"
  Normal  Pulled     2m9s   kubelet            Successfully pulled image "busybox" in 3.653s (3.653s including waiting). Image size: 2156518 bytes.
  Normal  Created    2m9s   kubelet            Created container: writer
  Normal  Started    2m9s   kubelet            Started container writer
  Normal  Pulling    2m9s   kubelet            Pulling image "busybox"
  Normal  Pulled     2m8s   kubelet            Successfully pulled image "busybox" in 1.075s (1.075s including waiting). Image size: 2156518 bytes.
  Normal  Created    2m8s   kubelet            Created container: reader
  Normal  Started    2m8s   kubelet            Started container reader

vboxuser@xubu:~/2.1$ 

```

<img width="1373" height="1043" alt="image" src="https://github.com/user-attachments/assets/6cb1021a-84cd-4be1-86ff-c47521fcc76f" />


2. Вывод команды tail -f /data/exchange.txt (или аналогичной команды для чтения файла).

<img width="1375" height="289" alt="image" src="https://github.com/user-attachments/assets/2a1b1a31-8ba6-433c-98ef-0e86f4eab6de" />

------

## Задание 2. PV, PVC
### Задача
Создать Deployment приложения, использующего локальный PV, созданный вручную.

### Шаги выполнения
1. Создать Deployment приложения, состоящего из контейнеров busybox и multitool, использующего созданный ранее PVC
2. Создать PV и PVC для подключения папки на локальной ноде, которая будет использована в поде.
3. Продемонстрировать, что контейнер multitool может читать данные из файла в смонтированной директории, в который busybox записывает данные каждые 5 секунд. 
4. Удалить Deployment и PVC. Продемонстрировать, что после этого произошло с PV. Пояснить, почему. (Используйте команду `kubectl describe pv`).
5. Продемонстрировать, что файл сохранился на локальном диске ноды. Удалить PV.  Продемонстрировать, что произошло с файлом после удаления PV. Пояснить, почему.


### Что сдать на проверку
- Манифесты:
  - `pv-pvc.yaml`
- Скриншоты:
  - каждый шаг выполнения задания, начиная с шага 2.
- Описания:
  - объяснение наблюдаемого поведения ресурсов в двух последних шагах.

### решение

```
vboxuser@xubu:~/2.1$ microk8s kubectl get po
NAME                             READY   STATUS    RESTARTS   AGE
data-exchange-598df4bc47-vkz27   2/2     Running   0          6m2s
multitool                        1/1     Running   4          82m
vboxuser@xubu:~/2.1$ microk8s kubectl delete pod data-exchange-598df4bc47-vkz27
pod "data-exchange-598df4bc47-vkz27" deleted
vboxuser@xubu:~/2.1$ microk8s kubectl apply -f pv-pvc.yaml
persistentvolume/local-pv created
persistentvolumeclaim/local-pvc created
deployment.apps/data-exchange-pvc created
vboxuser@xubu:~/2.1$ microk8s kubectl get pods
NAME                                 READY   STATUS    RESTARTS   AGE
data-exchange-598df4bc47-v24ld       2/2     Running   0          2m59s
data-exchange-pvc-5695dbbfb5-w55h8   0/2     Pending   0          7s
multitool                            1/1     Running   4          86m
vboxuser@xubu:~/2.1$ microk8s kubectl get pods
NAME                                 READY   STATUS    RESTARTS   AGE
data-exchange-598df4bc47-v24ld       2/2     Running   0          3m2s
data-exchange-pvc-5695dbbfb5-w55h8   0/2     Pending   0          10s
multitool                            1/1     Running   4          86m
vboxuser@xubu:~/2.1$ microk8s kubectl get pods
NAME                                 READY   STATUS    RESTARTS   AGE
data-exchange-598df4bc47-v24ld       2/2     Running   0          3m4s
data-exchange-pvc-5695dbbfb5-w55h8   0/2     Pending   0          12s
multitool                            1/1     Running   4          86m
vboxuser@xubu:~/2.1$ microk8s kubectl get pods
NAME                                 READY   STATUS    RESTARTS   AGE
data-exchange-598df4bc47-v24ld       2/2     Running   0          3m8s
data-exchange-pvc-5695dbbfb5-w55h8   0/2     Pending   0          16s
multitool                            1/1     Running   4          86m
vboxuser@xubu:~/2.1$ microk8s kubectl get pods
NAME                                 READY   STATUS    RESTARTS   AGE
data-exchange-598df4bc47-v24ld       2/2     Running   0          3m27s
data-exchange-pvc-5695dbbfb5-w55h8   2/2     Running   0          35s
multitool                            1/1     Running   4          87m

```

Удаление Deployment и PVC

```
vboxuser@xubu:~/2.1$ microk8s kubectl delete deployment data-exchange-pvc
deployment.apps "data-exchange-pvc" deleted
vboxuser@xubu:~/2.1$ microk8s kubectl delete pvc local-pvc
persistentvolumeclaim "local-pvc" deleted
vboxuser@xubu:~/2.1$ microk8s kubectl describe pv local-pv
Name:            local-pv
Labels:          <none>
Annotations:     pv.kubernetes.io/bound-by-controller: yes
Finalizers:      [kubernetes.io/pv-protection]
StorageClass:    
Status:          Released
Claim:           default/local-pvc
Reclaim Policy:  Retain
Access Modes:    RWO
VolumeMode:      Filesystem
Capacity:        1Gi
Node Affinity:   <none>
Message:         
Source:
    Type:          HostPath (bare host directory volume)
    Path:          /mnt/data
    HostPathType:  
Events:            <none>
vboxuser@xubu:~/2.1$ microk8s kubectl get pods
NAME                             READY   STATUS    RESTARTS   AGE
data-exchange-598df4bc47-v24ld   2/2     Running   0          6m12s
multitool                        1/1     Running   4          89m
vboxuser@xubu:~/2.1$ 

```

После удаления PVC, PV останется в состоянии "Released", так как он был привязан к PVC, поскольку политика persistentVolumeReclaimPolicy установлена на Retain, данные на локальном диске сохранятся.

```
vboxuser@xubu:~/2.1$ sudo find / -name timestamp.txt
find: ‘/run/user/1000/doc’: Permission denied
find: ‘/run/user/1000/gvfs’: Permission denied
/mnt/data/timestamp.txt
vboxuser@xubu:~/2.1$ cat /mnt/data/timestamp.txt
Sat Aug 2 10:43:03 UTC 2025
Sat Aug 2 10:43:08 UTC 2025
Sat Aug 2 10:43:13 UTC 2025
Sat Aug 2 10:43:18 UTC 2025
Sat Aug 2 10:43:23 UTC 2025
Sat Aug 2 10:43:28 UTC 2025
Sat Aug 2 10:43:33 UTC 2025
Sat Aug 2 10:43:38 UTC 2025
Sat Aug 2 10:43:43 UTC 2025
Sat Aug 2 10:43:48 UTC 2025
Sat Aug 2 10:43:53 UTC 2025
Sat Aug 2 10:43:58 UTC 2025
Sat Aug 2 10:44:03 UTC 2025
Sat Aug 2 10:44:08 UTC 2025
Sat Aug 2 10:44:13 UTC 2025
Sat Aug 2 10:44:18 UTC 2025
Sat Aug 2 10:44:23 UTC 2025
Sat Aug 2 10:44:28 UTC 2025
Sat Aug 2 10:44:33 UTC 2025
Sat Aug 2 10:44:38 UTC 2025
Sat Aug 2 10:44:43 UTC 2025
Sat Aug 2 10:44:48 UTC 2025
Sat Aug 2 10:44:53 UTC 2025
Sat Aug 2 10:44:58 UTC 2025
Sat Aug 2 10:45:03 UTC 2025
Sat Aug 2 10:45:08 UTC 2025
Sat Aug 2 10:45:13 UTC 2025
Sat Aug 2 10:45:18 UTC 2025
Sat Aug 2 10:45:23 UTC 2025
Sat Aug 2 10:45:28 UTC 2025
Sat Aug 2 10:45:33 UTC 2025
Sat Aug 2 10:45:38 UTC 2025
Sat Aug 2 10:45:43 UTC 2025
vboxuser@xubu:~/2.1$ microk8s kubectl delete pv local-pv
persistentvolume "local-pv" deleted
vboxuser@xubu:~/2.1$ microk8s kubectl describe pv local-pv
Error from server (NotFound): persistentvolumes "local-pv" not found
vboxuser@xubu:~/2.1$ sudo find / -name timestamp.txt
find: ‘/run/user/1000/doc’: Permission denied
find: ‘/run/user/1000/gvfs’: Permission denied
vboxuser@xubu:~/2.1$ cat /mnt/data/timestamp.txt
cat: /mnt/data/timestamp.txt: No such file or directory
```

При удалении PV с политикой Retain, данные остаются на диске. Однако если бы была установлена политика Delete, данные также были бы удалены вместе с PV.

------

## Задание 3. StorageClass
### Задача
Создать Deployment приложения, использующего PVC, созданный на основе StorageClass.

### Шаги выполнения

1. Создать Deployment приложения, состоящего из контейнеров busybox и multitool, использующего созданный ранее PVC.
2. Создать SC и PVC для подключения папки на локальной ноде, которая будет использована в поде.
3. Продемонстрировать, что контейнер multitool может читать данные из файла в смонтированной директории, в который busybox записывает данные каждые 5 секунд.

### Что сдать на проверку
- Манифесты:
  - `sc.yaml`
- Скриншоты:
  - каждый шаг выполнения задания, начиная с шага 2

### решение

```
vboxuser@xubu:~/2.1$ microk8s kubectl apply -f sc.yaml
storageclass.storage.k8s.io/local-storage-class created
persistentvolumeclaim/local-pvc created
deployment.apps/data-exchange-sc created
vboxuser@xubu:~/2.1$ microk8s kubectl get pods
NAME                                READY   STATUS    RESTARTS   AGE
data-exchange-598df4bc47-v24ld      2/2     Running   0          16m
data-exchange-sc-8695f5fbd9-hjqxs   2/2     Running   0          15s
multitool                           1/1     Running   4          99m
vboxuser@xubu:~/2.1$ sudo find / -name timestamp.txt
find: ‘/run/user/1000/doc’: Permission denied
find: ‘/run/user/1000/gvfs’: Permission denied
/mnt/data/timestamp.txt
vboxuser@xubu:~/2.1$ cat /mnt/data/timestamp.txt
Sat Aug 2 11:51:03 UTC 2025
Sat Aug 2 11:51:08 UTC 2025
Sat Aug 2 11:51:13 UTC 2025
Sat Aug 2 11:51:18 UTC 2025
Sat Aug 2 11:51:23 UTC 2025
Sat Aug 2 11:51:28 UTC 2025
Sat Aug 2 11:51:33 UTC 2025
Sat Aug 2 11:51:38 UTC 2025
Sat Aug 2 11:51:43 UTC 2025
Sat Aug 2 11:51:48 UTC 2025
Sat Aug 2 11:51:53 UTC 2025
Sat Aug 2 11:51:58 UTC 2025
```
